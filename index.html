<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Redirect Telegram | Auto Rotate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:24px; max-width:720px; margin:auto; text-align:center; }
    h2 { margin-top:56px; }
    .status { font-size:18px; margin-top:18px; color:#0a7c2f; }
    .error { color:#b00020; }
    .muted { color:#666; font-size:14px; margin-top:6px; }
    .badge { display:inline-block; margin-top:10px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #ddd; }
    a.btn { display:inline-block; padding:8px 12px; border-radius:10px; border:1px solid #ddd; margin-top:10px; text-decoration:none; }
  </style>
</head>
<body>
  <h2>üîÅ Auto Redirect Telegram</h2>
  <div class="badge"><strong>Mode:</strong> Auto Redirect</div>
  <p class="status" id="status">‚è≥ Memeriksa tetapan...</p>
  <p class="muted">Sedang memuatkan admin seterusnya...</p>
  <div id="countdown" style="display:none; margin-top:20px; padding:12px 24px; background:#0a7c2f; color:white; border-radius:8px; font-size:16px;">
    <span id="countdownText">Redirect dalam: <span id="timer">3</span> saat</span>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const countdownEl = document.getElementById("countdown");
    const timerEl = document.getElementById("timer");
    
    let rotationAdmins = [];
    let currentIndex = 0;
    let rotateEnabled = true;
    let countdownInterval = null;

    async function loadSettingsFromSupabase() {
      try {
        // Load global settings (rotate enabled/disabled and current index)
        const { data: settingsData, error: settingsError } = await supabaseClient
          .from('global_settings')
          .select('key, value')
          .in('key', ['rotate_enabled', 'current_rotation_index']);

        if (settingsError) {
          console.warn('Error loading global settings:', settingsError);
        } else if (settingsData) {
          settingsData.forEach(setting => {
            if (setting.key === 'rotate_enabled') {
              rotateEnabled = setting.value;
            } else if (setting.key === 'current_rotation_index') {
              currentIndex = setting.value || 0;
            }
          });
        }

        // Load rotation admins
        const { data: adminsData, error: adminsError } = await supabaseClient
          .from('rotation_admins')
          .select('*')
          .order('sort_order', { ascending: true });

        if (adminsError) {
          console.error('Error loading rotation admins:', adminsError);
          throw adminsError;
        }

        return {
          rotationAdmins: adminsData || [],
          rotateEnabled: rotateEnabled,
          currentIndex: currentIndex
        };
      } catch (error) {
        console.error('Failed to load settings from Supabase:', error);
        throw error;
      }
    }

    async function saveCurrentRotationIndex(index) {
      try {
        await supabaseClient
          .from('global_settings')
          .upsert({ key: 'current_rotation_index', value: index });
      } catch (error) {
        console.error('Error saving rotation index:', error);
      }
    }

    function startCountdown(admin, totalAdmins) {
      let timeLeft = 3;
      countdownEl.style.display = "block";
      
      const updateTimer = () => {
        timerEl.textContent = timeLeft;
        timeLeft--;
        
        if (timeLeft < 0) {
          clearInterval(countdownInterval);
          window.location.href = admin.link;
        }
      };
      
      updateTimer(); // Show initial count
      countdownInterval = setInterval(updateTimer, 1000);
    }

    async function autoRedirectToNext() {
      // Filter only enabled admins
      const active = rotationAdmins.filter(a => a && a.enabled && a.link);
      
      if (active.length === 0) {
        statusEl.classList.add("error");
        statusEl.textContent = "‚ùå Tiada admin aktif untuk rotate.";
        return;
      }

      // Randomly select an admin from active admins
      const randomIndex = Math.floor(Math.random() * active.length);
      const admin = active[randomIndex];
      
      // Save the random index to database (for admin panel display)
      await saveCurrentRotationIndex(randomIndex);
      
      statusEl.classList.remove("error");
      statusEl.textContent = `üîÅ Redirect ke: ${admin.name || 'admin'} (${randomIndex + 1}/${active.length}) - Random`;
      
      // Debug info
      console.log(`Random Rotation: Index ${randomIndex}, Admin: ${admin.name}, Total active: ${active.length}`);
      
      // Start countdown and redirect
      startCountdown(admin, active.length);
    }

    (async function boot(){
      try {
        statusEl.textContent = "‚è≥ Memuatkan tetapan dari Supabase...";
        
        const settings = await loadSettingsFromSupabase();
        
        if (!settings) {
          statusEl.classList.add("error");
          statusEl.textContent = "‚ùå Tidak dapat memuatkan tetapan.";
          return;
        }

        rotationAdmins = settings.rotationAdmins;
        rotateEnabled = settings.rotateEnabled;
        currentIndex = settings.currentIndex || 0;

        // Global OFF?
        if (!rotateEnabled) {
          statusEl.classList.add("error");
          statusEl.textContent = "‚õî Rotate dimatikan oleh admin (Global OFF).";
          return;
        }

        // Filter only enabled admins
        const active = rotationAdmins.filter(a => a && a.enabled && a.link);
        if (active.length === 0) {
          statusEl.classList.add("error");
          statusEl.textContent = "‚ùå Tiada admin aktif untuk rotate.";
          return;
        }

        // Show success message and start auto-redirect
        statusEl.classList.remove("error");
        statusEl.textContent = `‚úÖ Memuatkan admin seterusnya... ${active.length} admin aktif.`;
        
        // Start auto-redirect after a short delay
        setTimeout(() => {
          autoRedirectToNext();
        }, 1000);
        
      } catch (error) {
        statusEl.classList.add("error");
        statusEl.textContent = "‚ùå Ralat memuatkan tetapan. Sila cuba lagi.";
        console.error('Boot error:', error);
      }
    })();
  </script>
</body>
</html>